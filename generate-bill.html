<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Generator | Mutoiba Textiles</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        @media print { .no-print { display: none; } body { background: white; } .card { box-shadow: none; border: none; } }
        .bill-table th, .bill-table td { border-bottom: 1px solid #ddd; padding: 10px; text-align: left; }
    </style>
</head>
<body>
    <div class="no-print">
        <nav class="nav-bar"><strong>Mutoiba Textiles</strong> <a href="customers.html" style="color: white;">‚Üê Back</a></nav>
    </div>

    <div style="padding: 1rem; max-width: 700px; margin: auto;">
        <div class="card no-print" style="max-width: 100%; margin-bottom: 20px;">
            <h3>Select Item to Add</h3>
            <div style="display: flex; gap: 10px;">
                <select id="stock-select" style="flex: 2; padding: 10px;"></select>
                <input type="number" id="sell-qty" placeholder="Qty" style="flex: 1;">
                <button id="add-to-bill" style="flex: 1;">Add Item</button>
            </div>
        </div>

        <div id="printable-bill" class="card" style="max-width: 100%; background: #fff; color: #000;">
            <h2 style="text-align: center; margin-bottom: 0;">MUTOIBA TEXTILES</h2>
            <p style="text-align: center; margin-top: 5px; font-size: 0.8rem;">Al-Ahad Complex,Main Road, Azad Colony, Wagoora | 193109</p>
            <hr>
            <p><strong>Customer:</strong> <span id="bill-cust-name">Loading...</span></p>
            <p><strong>Date:</strong> <span id="bill-date"></span></p>
            
            <table class="bill-table" style="width: 100%; margin-top: 20px;">
                <thead>
                    <tr><th>Item</th><th>Qty</th><th>Rate</th><th>Total</th></tr>
                </thead>
                <tbody id="bill-items-body"></tbody>
            </table>

            <h2 style="text-align: right; margin-top: 20px;">Total: Rs. <span id="grand-total">0</span></h2>
        </div>

        <div class="no-print" style="margin-top: 20px; display: flex; gap: 10px;">
            <button onclick="window.print()" style="background: #444;">Print Receipt</button>
            <button id="finalize-bill" style="background: var(--primary);">Save & Update Ledger</button>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase.js';
        import { doc, getDoc, collection, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('id');
        let billItems = [];
        let totalBill = 0;

        // 1. Setup Page
        document.getElementById('bill-date').innerText = new Date().toLocaleDateString();
        
        const custSnap = await getDoc(doc(db, "customers", customerId));
        document.getElementById('bill-cust-name').innerText = custSnap.data().name;

        // 2. Load Stock into Dropdown
        const stockSnap = await getDocs(collection(db, "stocks"));
        const select = document.getElementById('stock-select');
        stockSnap.forEach(d => {
            const s = d.data();
            select.innerHTML += `<option value="${d.id}" data-price="${s.price}" data-name="${s.itemName}">${s.itemName} (Stock: ${s.quantity})</option>`;
        });

        // 3. Add Item to Temp List
        document.getElementById('add-to-bill').onclick = () => {
            const opt = select.options[select.selectedIndex];
            const qty = parseFloat(document.getElementById('sell-qty').value);
            const price = parseFloat(opt.dataset.price);
            const name = opt.dataset.name;
            const stockId = select.value;

            if(!qty) return;

            const rowTotal = qty * price;
            billItems.push({ stockId, name, qty, price, rowTotal });
            updateBillUI();
        };

        function updateBillUI() {
            const body = document.getElementById('bill-items-body');
            body.innerHTML = "";
            totalBill = 0;
            billItems.forEach(item => {
                totalBill += item.rowTotal;
                body.innerHTML += `<tr><td>${item.name}</td><td>${item.qty}</td><td>${item.price}</td><td style="text-align:right">${item.rowTotal}</td></tr>`;
            });
            document.getElementById('grand-total').innerText = totalBill;
        }

        // 4. Finalize (Update Inventory & Ledger)
        document.getElementById('finalize-bill').onclick = async () => {
            if(billItems.length === 0) return;

            // Add to Ledger as Credit
            await addDoc(collection(db, "transactions"), {
                customerId, amount: totalBill, type: 'credit', date: serverTimestamp(), note: 'Purchase Bill'
            });

            // Update Customer Total Balance
            const newBalance = (custSnap.data().balance || 0) + totalBill;
            await updateDoc(doc(db, "customers", customerId), { balance: newBalance });

            // Subtract Stocks
            for (const item of billItems) {
                const sRef = doc(db, "stocks", item.stockId);
                const sSnap = await getDoc(sRef);
                await updateDoc(sRef, { quantity: sSnap.data().quantity - item.qty });
            }

            alert("Bill Finalized!");
            window.location.href = `ledger.html?id=${customerId}`;
        };
    </script>
</body>
</html>
