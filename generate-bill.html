  <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bill Generator | Mutoiba Textiles</title>
    <link rel="stylesheet" href="css/style.css">
    <style>
        @media print { 
            .no-print { display: none; } 
            body { background: white; padding: 0; } 
            .card { box-shadow: none; border: none; width: 100% !important; max-width: 100% !important; }
        }
        .bill-header { text-align: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .bill-header h1 { margin: 0; font-size: 24px; letter-spacing: 2px; }
        .bill-header p { margin: 2px 0; font-size: 13px; color: #333; }
        
        .bill-info { display: flex; justify-content: space-between; margin-bottom: 20px; font-size: 14px; line-height: 1.6; }
        
        .bill-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 1px solid #000; }
        .bill-table th { background: #f4f4f4; border: 1px solid #000; padding: 10px; text-align: left; }
        .bill-table td { border-right: 1px solid #000; border-left: 1px solid #000; padding: 10px; text-align: left; height: 25px; }
        .bill-table tr:last-child td { border-bottom: 1px solid #000; }
        
        .total-section { text-align: right; margin-top: 0; border: 1px solid #000; border-top: none; padding: 10px; background: #f9f9f9; }
        .footer-note { margin-top: 20px; font-size: 11px; line-height: 1.4; border: 1px solid #eee; padding: 10px; border-radius: 5px; }
        .signature-area { display: flex; justify-content: space-between; margin-top: 60px; font-weight: bold; }
    </style>
</head>
<body>
    <div class="no-print">
        <nav class="nav-bar"><strong>Mutoiba Textiles</strong> <a href="customers.html" style="color: white; margin-left: 20px;">← Back</a></nav>
    </div>

    <div style="padding: 1rem; max-width: 800px; margin: auto;">
        <div class="card no-print" style="margin-bottom: 20px;">
            <h3>Add Items to Invoice</h3>
            <div style="display: flex; gap: 10px;">
                <select id="stock-select" style="flex: 2; padding: 10px;"></select>
                <input type="number" id="sell-qty" placeholder="Qty" style="flex: 1; padding: 10px;">
                <button id="add-to-bill" style="flex: 1; cursor: pointer; background: #444; color: white; border: none; border-radius: 4px;">Add Item</button>
            </div>
        </div>

        <div id="printable-bill" class="card" style="background: #fff; color: #000; padding: 40px; border: 1px solid #ccc;">
            <div class="bill-header">
                <h1>MUTOIBA TEXTILES</h1>
                <p>Al-Ahad Complex, Main Road, Azad Colony, Near J&K Bank</p>
                <p>Wagoora, Jammu & Kashmir - 193109</p>
                <p><strong>Mobile:</strong> 7006261669 | <strong>Email:</strong> mutoibatextiles@gmail.com</p>
            </div>

            <div class="bill-info">
                <div>
                    <p><strong>Customer:</strong> <span id="bill-cust-name">Loading...</span></p>
                    <p><strong>Mobile:</strong> <span id="bill-cust-phone">Loading...</span></p>
                </div>
                <div style="text-align: right;">
                    <p><strong>Date:</strong> <span id="bill-date"></span></p>
                    <p><strong>Bill No:</strong> <span id="bill-number" style="font-weight: bold; color: #d32f2f;"></span></p>
                </div>
            </div>
            
            <table class="bill-table">
                <thead>
                    <tr>
                        <th style="width: 10%;">S.No</th>
                        <th style="width: 50%;">Item Description</th>
                        <th>Qty</th>
                        <th>Rate (₹)</th>
                        <th style="text-align: right;">Total (₹)</th>
                    </tr>
                </thead>
                <tbody id="bill-items-body">
                    </tbody>
            </table>

            <div class="total-section">
                <span style="font-size: 1.2rem; font-weight: bold;">Grand Total: ₹ <span id="grand-total">0</span></span>
            </div>

            <div class="footer-note">
                <strong>Terms & Conditions:</strong>
                <p>1. Goods once sold will not be taken back. Exchange possible within 7 days.<br>
                2. Cut pieces or washed items will not be accepted for exchange.<br>
                3. This is a computer-generated invoice.</p>
            </div>

            <div class="signature-area">
                <p style="border-top: 1px solid #000; padding-top: 5px; width: 150px; text-align: center;">Customer</p>
                <p style="border-top: 1px solid #000; padding-top: 5px; width: 200px; text-align: center;">For Mutoiba Textiles</p>
            </div>
        </div>

        <div class="no-print" style="margin-top: 20px; display: flex; gap: 10px; justify-content: center;">
            <button onclick="window.print()" style="background: #444; color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Print Bill</button>
            <button id="finalize-bill" style="background: #27ae60; color: white; padding: 12px 25px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold;">Finalize & Save</button>
        </div>
    </div>

    <script type="module">
        import { db } from './js/firebase.js';
        import { doc, getDoc, collection, getDocs, addDoc, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('id');
        let billItems = [];
        let totalBill = 0;

        // --- AUTO GENERATE BILL NUMBER ---
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const date = String(now.getDate()).padStart(2, '0');
        const randomID = Math.floor(1000 + Math.random() * 9000); // 4 digit random
        const autoBillNo = `MT/${year}/${month}${date}-${randomID}`;
        
        document.getElementById('bill-number').innerText = autoBillNo;
        document.getElementById('bill-date').innerText = `${date}/${month}/${year}`;
        
        // Fetch Customer
        const custSnap = await getDoc(doc(db, "customers", customerId));
        if (custSnap.exists()) {
            const data = custSnap.data();
            document.getElementById('bill-cust-name').innerText = data.name;
            document.getElementById('bill-cust-phone').innerText = data.phone || data.mobile || "N/A";
        }

        // Load Stocks
        const stockSnap = await getDocs(collection(db, "stocks"));
        const select = document.getElementById('stock-select');
        stockSnap.forEach(d => {
            const s = d.data();
            select.innerHTML += `<option value="${d.id}" data-price="${s.price}" data-name="${s.itemName}">${s.itemName} (Stock: ${s.quantity})</option>`;
        });

        document.getElementById('add-to-bill').onclick = () => {
            const opt = select.options[select.selectedIndex];
            const qty = parseFloat(document.getElementById('sell-qty').value);
            const price = parseFloat(opt.dataset.price);
            const name = opt.dataset.name;
            const stockId = select.value;

            if(!qty || qty <= 0) return;

            const rowTotal = qty * price;
            billItems.push({ stockId, name, qty, price, rowTotal });
            updateBillUI();
            document.getElementById('sell-qty').value = "";
        };

        function updateBillUI() {
            const body = document.getElementById('bill-items-body');
            body.innerHTML = "";
            totalBill = 0;
            billItems.forEach((item, index) => {
                totalBill += item.rowTotal;
                body.innerHTML += `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${item.name}</td>
                        <td>${item.qty}</td>
                        <td>${item.price.toFixed(2)}</td>
                        <td style="text-align:right">${item.rowTotal.toFixed(2)}</td>
                    </tr>`;
            });
            document.getElementById('grand-total').innerText = totalBill.toLocaleString('en-IN');
        }

        document.getElementById('finalize-bill').onclick = async () => {
            if(billItems.length === 0) { alert("Please add items first"); return; }
            try {
                // Save transaction with the generated Bill Number
                await addDoc(collection(db, "transactions"), {
                    customerId, 
                    amount: totalBill, 
                    type: 'credit', 
                    billNo: autoBillNo,
                    date: serverTimestamp(), 
                    note: 'Purchase Bill'
                });

                const newBalance = (custSnap.data().balance || 0) + totalBill;
                await updateDoc(doc(db, "customers", customerId), { balance: newBalance });

                for (const item of billItems) {
                    const sRef = doc(db, "stocks", item.stockId);
                    const sSnap = await getDoc(sRef);
                    await updateDoc(sRef, { quantity: sSnap.data().quantity - item.qty });
                }

                alert("Bill Finalized and Inventory Updated!");
                window.location.href = `ledger.html?id=${customerId}`;
            } catch (e) { 
                console.error(e);
                alert("Error finalizing bill"); 
            }
        };
    </script>
</body>
</html>
 
