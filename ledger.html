<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Ledger | Mutoiba Textiles</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="nav-bar">
        <strong>Mutoiba Textiles</strong>
        <a href="customers.html" style="color: white; text-decoration: none;">‚Üê Back to List</a>
    </nav>

    <div style="padding: 1rem; max-width: 800px; margin: auto;">
        
        <div class="card" style="max-width: 100%; margin-bottom: 20px; border-top: 5px solid var(--primary);">
            <div style="display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 10px;">
                <div>
                    <h2 id="customer-name" style="color: var(--primary); margin: 0;">Loading...</h2>
                    <p id="customer-phone" style="color: #666; margin: 5px 0;"></p>
                </div>
                <div style="text-align: right;">
                    <small>Current Balance</small>
                    <h1 id="total-balance" style="color: var(--danger); margin: 0;">Rs. 0</h1>
                </div>
            </div>
            
            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button id="whatsapp-btn" style="background-color: #25D366; flex: 1; display: none; font-size: 0.9rem;">
                    WhatsApp Reminder
                </button>
                <button id="sms-btn" style="background-color: #007bff; flex: 1; display: none; font-size: 0.9rem;">
                    SMS (SIM Balance)
                </button>
            </div>
        </div>

        <div class="card" style="max-width: 100%; margin-bottom: 20px;">
            <h3 style="margin-top: 0;">Record Transaction</h3>
            <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                <input type="number" id="amount" placeholder="Amount" style="flex: 2; min-width: 120px;">
                <select id="type" style="flex: 1; min-width: 110px; padding: 10px; border-radius: 6px;">
                    <option value="credit">Credit (Baki)</option>
                    <option value="payment">Payment (Wasooli)</option>
                </select>
                <button id="add-trans-btn" style="flex: 1; min-width: 80px;">Save</button>
            </div>
        </div>

        <h3 style="margin-left: 10px;">History</h3>
        <div style="overflow-x: auto;">
            <table style="width: 100%; background: white; border-radius: 8px; border-collapse: collapse; font-size: 0.9rem;">
                <thead style="background: var(--primary); color: white;">
                    <tr>
                        <th style="padding: 12px; text-align: left;">Date</th>
                        <th style="padding: 12px; text-align: left;">Type</th>
                        <th style="padding: 12px; text-align: right;">Amount</th>
                    </tr>
                </thead>
                <tbody id="ledger-history"></tbody>
            </table>
        </div>
    </div>

    <script type="module">
        import { db, auth } from './js/firebase.js';
        import { doc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, serverTimestamp, orderBy } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('id');

        // Page Security
        onAuthStateChanged(auth, (user) => {
            if (!user) window.location.href = 'index.html';
        });

        if (!customerId) {
            alert("No customer selected!");
            window.location.href = 'customers.html';
        }

        async function initPage() {
            const docRef = doc(db, "customers", customerId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                const balance = data.balance || 0;
                
                document.getElementById('customer-name').innerText = data.name;
                document.getElementById('customer-phone').innerText = data.phone;
                document.getElementById('total-balance').innerText = "Rs. " + balance.toLocaleString();

                setupReminders(data.name, data.phone, balance);
                loadHistory();
            }
        }

        function setupReminders(name, phone, balance) {
            const waBtn = document.getElementById('whatsapp-btn');
            const smsBtn = document.getElementById('sms-btn');
            
            if (balance > 0) {
                waBtn.style.display = "block";
                smsBtn.style.display = "block";

                const cleanPhone = phone.replace(/\D/g, ''); 
                const msg = `Mutoiba Textiles:\nDear ${name}, your outstanding balance is Rs. ${balance}.\nPlease clear your dues. Thank you.`;

                // WhatsApp Logic
                waBtn.onclick = () => {
                    window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(msg)}`, '_blank');
                };

                // Device SIM SMS Logic
                smsBtn.onclick = () => {
                    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
                    const separator = isIOS ? '&' : '?';
                    window.location.href = `sms:${cleanPhone}${separator}body=${encodeURIComponent(msg)}`;
                };
            }
        }

        async function loadHistory() {
            const q = query(
                collection(db, "transactions"), 
                where("customerId", "==", customerId),
                orderBy("date", "desc")
            );
            
            const querySnapshot = await getDocs(q);
            const historyBody = document.getElementById('ledger-history');
            historyBody.innerHTML = "";
            
            querySnapshot.forEach((doc) => {
                const t = doc.data();
                const date = t.date ? t.date.toDate().toLocaleDateString() : 'New';
                const color = t.type === 'credit' ? '#e53935' : '#43a047';
                
                historyBody.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee;">
                        <td style="padding: 12px;">${date}</td>
                        <td style="padding: 12px; color: ${color}; font-weight: bold;">${t.type.toUpperCase()}</td>
                        <td style="padding: 12px; text-align: right; font-weight: bold;">Rs. ${t.amount.toLocaleString()}</td>
                    </tr>
                `;
            });
        }

        document.getElementById('add-trans-btn').onclick = async () => {
            const amountVal = document.getElementById('amount').value;
            const amount = parseFloat(amountVal);
            const type = document.getElementById('type').value;

            if (!amount || amount <= 0) return alert("Enter a valid amount");

            const btn = document.getElementById('add-trans-btn');
            btn.innerText = "...";
            btn.disabled = true;

            try {
                await addDoc(collection(db, "transactions"), {
                    customerId,
                    amount,
                    type,
                    date: serverTimestamp()
                });

                const docRef = doc(db, "customers", customerId);
                const docSnap = await getDoc(docRef);
                const currentBalance = docSnap.data().balance || 0;
                const newBalance = type === 'credit' ? currentBalance + amount : currentBalance - amount;
                
                await updateDoc(docRef, { balance: newBalance });
                location.reload();
            } catch (err) {
                alert("Error: " + err.message);
                btn.disabled = false;
            }
        };

        initPage();
    </script>
</body>
</html>

