<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Customer Ledger | Mutoiba Textiles</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav class="nav-bar">
        <strong>Mutoiba Textiles</strong>
        <a href="customers.html" style="color: white;">‚Üê Back to List</a>
    </nav>

    <div style="padding: 2rem; max-width: 800px; margin: auto;">
        <div class="card" style="max-width: 100%; margin-bottom: 20px;">
            <h2 id="customer-name" style="color: var(--primary); margin: 0;">Loading...</h2>
            <p id="customer-phone" style="color: #666;"></p>
            <h1 id="total-balance" style="color: var(--danger); margin: 10px 0;">Rs. 0</h1>
        </div>

        <div class="card" style="max-width: 100%; margin-bottom: 20px;">
            <h3>Add Transaction</h3>
            <div style="display: flex; gap: 10px;">
                <input type="number" id="amount" placeholder="Amount (e.g. 5000)">
                <select id="type" style="width: auto; padding: 10px;">
                    <option value="credit">Credit (Baki)</option>
                    <option value="payment">Payment (Wasooli)</option>
                </select>
                <button id="add-trans-btn" style="width: auto; padding: 0 20px;">Add</button>
            </div>
        </div>

        <table style="width: 100%; background: white; border-radius: 8px; overflow: hidden;">
            <thead style="background: var(--primary); color: white;">
                <tr>
                    <th style="padding: 10px;">Date</th>
                    <th style="padding: 10px;">Type</th>
                    <th style="padding: 10px;">Amount</th>
                </tr>
            </thead>
            <tbody id="ledger-history"></tbody>
        </table>
    </div>

    <script type="module">
        import { db } from './js/firebase.js';
        import { doc, getDoc, collection, addDoc, query, where, getDocs, updateDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        const urlParams = new URLSearchParams(window.location.search);
        const customerId = urlParams.get('id');

        if (!customerId) {
            alert("No customer selected!");
            window.location.href = 'customers.html';
        }

        // 1. Load Customer Details
        async function loadLedger() {
            const docRef = doc(db, "customers", customerId);
            const docSnap = await getDoc(docRef);

            if (docSnap.exists()) {
                const data = docSnap.data();
                document.getElementById('customer-name').innerText = data.name;
                document.getElementById('customer-phone').innerText = data.phone;
                document.getElementById('total-balance').innerText = "Rs. " + (data.balance || 0);
            }
            loadHistory();
        }

        // 2. Load History
        async function loadHistory() {
            const q = query(collection(db, "transactions"), where("customerId", "==", customerId));
            const querySnapshot = await getDocs(q);
            const historyBody = document.getElementById('ledger-history');
            historyBody.innerHTML = "";
            
            querySnapshot.forEach((doc) => {
                const t = doc.data();
                historyBody.innerHTML += `
                    <tr style="border-bottom: 1px solid #eee; text-align: center;">
                        <td style="padding: 10px;">${t.date ? t.date.toDate().toLocaleDateString() : 'Pending'}</td>
                        <td style="padding: 10px; color: ${t.type === 'credit' ? 'red' : 'green'}">${t.type.toUpperCase()}</td>
                        <td style="padding: 10px;">Rs. ${t.amount}</td>
                    </tr>
                `;
            });
        }

        // 3. Add Transaction Logic
        document.getElementById('add-trans-btn').onclick = async () => {
            const amount = parseFloat(document.getElementById('amount').value);
            const type = document.getElementById('type').value;

            if (!amount) return alert("Enter amount");

            // Save Transaction
            await addDoc(collection(db, "transactions"), {
                customerId,
                amount,
                type,
                date: serverTimestamp()
            });

            // Update Customer Balance
            const docRef = doc(db, "customers", customerId);
            const docSnap = await getDoc(docRef);
            let currentBalance = docSnap.data().balance || 0;
            
            // If credit (baki), add to balance. If payment (wasooli), subtract.
            let newBalance = type === 'credit' ? currentBalance + amount : currentBalance - amount;
            
            await updateDoc(docRef, { balance: newBalance });

            location.reload(); // Refresh to see changes
        };

        loadLedger();
    </script>
</body>
</html>
